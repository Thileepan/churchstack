<?php

$APPLICATION_PATH = "../";

//This files secures the action being triggered by cross-domain attacks
include $APPLICATION_PATH."utils/validateauth.php";

include_once $APPLICATION_PATH . 'classes/class.church.php';

//process request
$req = $_REQUEST['req'];

if($req == 1)
{
	//church information add/edit form page

	$is_update = $_REQUEST['isUpdate'];
	$curr_church_id = $_SESSION["churchID"];
	if($is_update)
	{
		$church_obj = new Church($APPLICATION_PATH);
		//$church_details = $church_obj->getChurchInformation();
		$church_details = $church_obj->getInformationOfAChurch($curr_church_id);
		//array($church_id, $church_name, $church_desc, $church_addr, $landline, $mobile, $email, $website, $signup_time, $last_update_time, $sharded_database, $currency_id, $unique_hash, $status, $country_id, $referrer_church_id, $time_zone);
		if($church_details[0]==1)
		{
			$church_id = $church_details[1][0];
			$church_name = $church_details[1][1];
			$church_desc = $church_details[1][2];
			$church_addr = $church_details[1][3];
			$landline = $church_details[1][4];
			$mobile = $church_details[1][5];
			$email = $church_details[1][6];
			$website = $church_details[1][7];
			$signup_time = $church_details[1][8];
			$last_modified_time = $church_details[1][9];
			$sharded_db = $church_details[1][10];
			$currency_id = $church_details[1][11];
			$unique_hash = $church_details[1][12];
			$status = $church_details[1][13];
			$country_id = $church_details[1][14];
			$referrer_church_id = $church_details[1][15];
			$time_zone = $church_details[1][16];
		}
	}

	$to_return = '';
	$to_return .= '<div class="row-fluid">';
		$to_return .= '<div id="harvestFormDiv" class="span6">';
			$to_return .= '<form class="form-horizontal" onsubmit="return false;">';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputChurchName">Name of the Church</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<input type="text" class="span8" id="inputChurchName" placeholder="Church Name" value="'.$church_name.'">';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputChurchDesc">About Church</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<textarea class="span8" id="inputChurchDesc" placeholder="About Church">'.$church_desc.'</textarea>';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputChurchAddress">Address</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<textarea class="span8" id="inputChurchAddress" placeholder="Address">'.$church_addr.'</textarea>';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputLandline">Landline</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<input type="text" class="span8" id="inputLandline" placeholder="Landline" value="'.$landline.'">';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputMobile">Mobile</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<input type="text" class="span8" id="inputMobile" placeholder="Mobile" value="'.$mobile.'">';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputEmail">Email</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<input type="text" class="span8" id="inputEmail" placeholder="Email" value="'.$email.'">';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputWebsite">Website</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<input type="text" class="span8" id="inputWebsite" placeholder="Website" value="'.$website.'">';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="row-fluid">';
					$to_return .= '<div class="span12">';
					  $to_return .= '<div class="form-actions">';
						$to_return .= '<button class="btn btn-primary" onclick="addOrUpdateChurchInfo('.$is_update.');">'.(($is_update)?'Update':'Save Changes').'</button>&nbsp;';
						if(!$is_update) {
							$to_return .= '<button class="btn" type="reset">Reset</button>';
						} else {
							$to_return .= '<button class="btn" onclick="getChurchInformation();">Cancel</button>';
						}						
					  $to_return .= '</div>';
					$to_return .= '</div>';
				$to_return .= '</div>';
			$to_return .= '</form>';
		$to_return .= '</div>';
	$to_return .= '</div>';

	echo $to_return;
	exit;
}
else if($req == 2)
{
	//add or update church information in database
	$church_name = trim($_POST['churchName']);
	$church_desc = trim($_POST['churchDesc']);
	$church_addr = trim($_POST['churchAddr']);
	$landline = trim($_POST['landline']);
	$mobile = trim($_POST['mobile']);
	$email = trim($_POST['email']);
	$website = trim($_POST['website']);
	$is_update = trim($_POST['isUpdate']);
	$signup_time = time();
	$last_modified_time = time();
	$currency_id = trim($_POST['currencyID']);
	$country_id = trim($_POST['countryID']);
	$time_zone = trim($_POST['timeZone']);
	
	$church_obj = new Church($APPLICATION_PATH);
	if(!$is_update) {
		$status = $church_obj->addChurchInformation($church_name, $church_desc, $church_addr, $landline, $mobile, $email, $website, $currency_id, $country_id, 0, $time_zone);
	} else {
		$status = $church_obj->updateChurchInformation($church_name, $church_desc, $church_addr, $landline, $mobile, $email, $website, $last_modified_time, $currency_id, $country_id, $time_zone);
	}

	echo $status;
	exit;
}
else if($req == 3)
{
	$curr_church_id = $_SESSION["churchID"];
	//get church information
	$church_obj = new Church($APPLICATION_PATH);
	//$church_details = $church_obj->getChurchInformation();
	$church_details = $church_obj->getInformationOfAChurch($curr_church_id);
	//array($church_id, $church_name, $church_desc, $church_addr, $landline, $mobile, $email, $website, $signup_time, $last_update_time, $sharded_database, $currency_id, $unique_hash, $status, $country_id, $referrer_church_id, $time_zone);
	$to_return = '';
	if($church_details[0]==1)
	{
		$church_id = $church_details[1][0];
		$church_name = $church_details[1][1];
		$church_desc = $church_details[1][2];
		$church_addr = $church_details[1][3];
		$landline = $church_details[1][4];
		$mobile = $church_details[1][5];
		$email = $church_details[1][6];
		$website = $church_details[1][7];
		$signup_time = $church_details[1][8];
		$last_modified_time = $church_details[1][9];
		$sharded_db = $church_details[1][10];
		$currency_id = $church_details[1][11];
		$unique_hash = $church_details[1][12];
		$status = $church_details[1][13];
		$country_id = $church_details[1][14];
		$referrer_church_id = $church_details[1][15];
		$time_zone = $church_details[1][16];

		$to_return .= '<div class="row-fluid">';
			$to_return .= '<div class="span8">';
				$to_return .= '<div>';
					$to_return .= '<b>';
						$to_return .= $church_name;
					$to_return .= '</b>&nbsp;&nbsp;&nbsp;<a href="#" onclick="getChurchInformationForm(1)">(Edit)</a>';
					$to_return .= '<BR><span class="muted">'.$church_desc.'</span>';
				$to_return .= '</div><BR>';
				$to_return .= '<div>';
					$to_return .= '<pre>';
					if(trim($church_desc) != "") {
						$to_return .= $church_desc;
					}
					if(trim($church_addr) != "") {
						$to_return .= '<BR><abbr title="Address">Address :</abbr>&nbsp;'.$church_addr;
					}
					if(trim($landline) != "") {
						$to_return .= '<BR><abbr title="Phone">Phone :</abbr>&nbsp;'.$landline;
					}
					if(trim($mobile) != "") {
						$to_return .= '<BR><abbr title="Mobile">Mobile :</abbr>&nbsp;'.$mobile;
					}
					if(trim($email) != "") {
						$to_return .= '<BR><abbr title="Mobile">Email :</abbr>&nbsp;'.$email;
					}
					if(trim($website) != "") {
						$to_return .= "<BR><a href='".$website."' target='_blank'>".$website."</a>";
					}
					if(trim($time_zone) != "") {
						$to_return .= "<BR>".$time_zone;
					}
					
				$to_return .= '</pre>';
				$to_return .= '</div><BR>';
			$to_return .= '</div>';
		$to_return .= '</div>';
	}
	else
	{
		$to_return .= '<div class="row-fluid">';
			$to_return .= '<div class="span12">';
				$to_return .= '<div class="alert alert-info"><b>Heads up!</b> You haven\'t added any information about your church yet. <a href="#" onclick="getChurchInformationForm(0);"><u>Click Here</u></a> to add.</div>';
			$to_return .= '</div>';
		$to_return .= '</div>';
	}

	echo $to_return;
	exit;
}
else if($req == 4)
{
	//get billing details

	$to_return .= '<div class="row-fluid">';
		$to_return .= '<div class="span10">';
			$to_return .= '<div class="widget">';
				$to_return .= '<div class="widget-header" style="background-color: lightgrey;color:black;">';
					$to_return .= '<i class="icon-asterisk icon-white"></i>';
		//			$to_return .= '<h3>Subscriptions ['.$dt->year.'] - In Indian Rupees</h3>';
					$to_return .= '<h3>Contributions</h3>';
					$to_return .= '<span class="pull-right" style="padding-right:10px;"><i class="icon-refresh icon-white curHand" onclick="getDashboardData(2);"></i></span>';
				$to_return .= '</div>';
				$to_return .= '<div class="widget-content">';
					$to_return .= '<div class="stats">';
						$to_return .= '<div class="stat">';
							$to_return .= '<span class="stat-value">'.$current_month_amount.'</span>';
							$to_return .= '<span class="muted">'.$current_month_in_string .','.$current_year_in_string.'</span>';
						$to_return .= '</div>';
						$to_return .= '<div class="stat">';
							$to_return .= '<span class="stat-value">'.$last_month_amount.'</span>';
							$to_return .= '<span class="muted">'.$last_month_in_string . ','.$last_year_in_string.'</span>';
						$to_return .= '</div>';
						$to_return .= '<div class="stat">';
							$to_return .= '<span class="stat-value">'.$prev_month_amount.'</span>';
							$to_return .= '<span class="muted">'.$prev_month_in_string . ','.$prev_year_in_string.'</span>';
						$to_return .= '</div>';
					$to_return .= '</div>';
				$to_return .= '</div>';
			$to_return .= '</div>';
		$to_return .= '</div>';
	$to_return .= '</div>';

	echo $to_return;
	exit;
}

?>