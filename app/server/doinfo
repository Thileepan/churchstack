<?php

$APPLICATION_PATH = "../";

//This files secures the action being triggered by cross-domain attacks
include $APPLICATION_PATH."utils/validateauth.php";

include_once $APPLICATION_PATH . 'classes/class.church.php';
include_once $APPLICATION_PATH . 'classes/class.utility.php';
include_once $APPLICATION_PATH . 'classes/class.users.php';
include_once $APPLICATION_PATH . 'utils/JSON.php';

//process request
$req = $_REQUEST['req'];

if($req == 1)
{
	//church information add/edit form page

	$is_update = $_REQUEST['isUpdate'];
	$curr_church_id = $_SESSION["churchID"];
	$currency_list = array();
	$country_list = array();
	$timezone_list = array();
	if($is_update)
	{
		$church_obj = new Church($APPLICATION_PATH);
		//$church_details = $church_obj->getChurchInformation();
		$church_details = $church_obj->getInformationOfAChurch($curr_church_id);
		//array($church_id, $church_name, $church_desc, $church_addr, $landline, $mobile, $email, $website, $signup_time, $last_update_time, $sharded_database, $currency_id, $unique_hash, $status, $country_id, $referrer_church_id, $time_zone);
		if($church_details[0]==1)
		{
			$church_id = $church_details[1][0];
			$church_name = $church_details[1][1];
			$church_desc = $church_details[1][2];
			$church_addr = $church_details[1][3];
			$landline = $church_details[1][4];
			$mobile = $church_details[1][5];
			$email = $church_details[1][6];
			$website = $church_details[1][7];
			$signup_time = $church_details[1][8];
			$last_modified_time = $church_details[1][9];
			$sharded_db = $church_details[1][10];
			$currency_id = $church_details[1][11];
			$unique_hash = $church_details[1][12];
			$status = $church_details[1][13];
			$country_id = $church_details[1][14];
			$referrer_church_id = $church_details[1][15];
			$time_zone = $church_details[1][16];

			$country_result = $church_obj->getCountryDetails();//Lists all countries
			if($country_result[0]==1)
			{
				$country_list = $country_result[1];
			}
			$currency_result = $church_obj->getCurrencyDetails();//Lists all currencies
			if($currency_result[0]==1)
			{
				$currency_list = $currency_result[1];
			}

			$util_obj = new Utility($APPLICATION_PATH);
			$timezone_list = $util_obj->getTimeZonesList();
		}
	}

	$to_return = '';
	$to_return .= '<div class="row-fluid">';
		$to_return .= '<div id="harvestFormDiv" class="span6">';
			$to_return .= '<form class="form-horizontal" onsubmit="return false;">';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputChurchName">Name of the Church</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<input type="text" class="span8" id="inputChurchName" placeholder="Church Name" value="'.$church_name.'">';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputChurchDesc">About Church</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<textarea class="span8" id="inputChurchDesc" placeholder="About Church">'.$church_desc.'</textarea>';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputChurchAddress">Address</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<textarea class="span8" id="inputChurchAddress" placeholder="Address">'.$church_addr.'</textarea>';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputLandline">Landline</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<input type="text" class="span8" id="inputLandline" placeholder="Landline" value="'.$landline.'">';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputMobile">Mobile</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<input type="text" class="span8" id="inputMobile" placeholder="Mobile" value="'.$mobile.'">';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputEmail">Email</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<input type="text" class="span8" id="inputEmail" placeholder="Email" value="'.$email.'">';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputWebsite">Website</label>';
						$to_return .= '<div class="controls">';
							$to_return .= '<input type="text" class="span8" id="inputWebsite" placeholder="Website" value="'.$website.'">';
						$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputCountryID">Country</label>';
					$to_return .= '<div class="controls">';
						$to_return .= '<select class="form-control" id="inputCountryID" name="inputCountryID">';
						for($c=0; $c < COUNT($country_list); $c++)
						{
							$selected_text = ((trim($country_id) == trim($country_list[$c][0]))? " selected" : "");//Note the space
							$to_return .= '<option value="'.$country_list[$c][0].'"'.$selected_text.'>'.$country_list[$c][3].'</option>';
						}
						$to_return .= '</select>';
					$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputTimeZone">Local TimeZone</label>';
					$to_return .= '<div class="controls">';
						$to_return .= '<select class="form-control" id="inputTimeZone" name="inputTimeZone">';
						for($t=0; $t < COUNT($timezone_list); $t++)
						{
							$selected_text = ((trim($time_zone) == $timezone_list[$t]["zone"])? " selected" : "");//Note the space
							$to_return .= '<option value="'.$timezone_list[$t]["zone"].'"'.$selected_text.'>'.$timezone_list[$t]["zone"].' ('.$timezone_list[$t]["diff_from_GMT"].')</option>';
						}
						$to_return .= '</select>';
					$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="control-group">';
					$to_return .= '<label class="control-label" for="inputCurrencyID">Local Currency</label>';
					$to_return .= '<div class="controls">';
						$to_return .= '<select class="form-control" id="inputCurrencyID" name="inputCurrencyID">';
						for($v=0; $v < COUNT($currency_list); $v++)
						{
							$selected_text = ((trim($currency_id) == $currency_list[$v][0])? " selected" : "");//Note the space
							$to_return .= '<option value="'.$currency_list[$v][0].'"'.$selected_text.'>'.$currency_list[$v][3].' ('.$currency_list[$v][1].')</option>';
						}
						$to_return .= '</select>';
					$to_return .= '</div>';
				$to_return .= '</div>';
				$to_return .= '<div class="row-fluid">';
					$to_return .= '<div class="span12">';
					  $to_return .= '<div class="form-actions">';
						$to_return .= '<button class="btn btn-primary" onclick="addOrUpdateChurchInfo('.$is_update.');">'.(($is_update)?'Update':'Save Changes').'</button>&nbsp;';
						if(!$is_update) {
							$to_return .= '<button class="btn" type="reset">Reset</button>';
						} else {
							$to_return .= '<button class="btn" onclick="getChurchInformation();">Cancel</button>';
						}						
					  $to_return .= '</div>';
					$to_return .= '</div>';
				$to_return .= '</div>';
			$to_return .= '</form>';
		$to_return .= '</div>';
	$to_return .= '</div>';

	echo $to_return;
	exit;
}
else if($req == 2)
{
	//add or update church information in database
	$church_name = trim(stripslashes(rawurldecode($_POST['churchName'])));
	$church_desc = trim(stripslashes(rawurldecode($_POST['churchDesc'])));
	$church_addr = trim(stripslashes(rawurldecode($_POST['churchAddr'])));
	$landline = trim(stripslashes(rawurldecode($_POST['landline'])));
	$mobile = trim(stripslashes(rawurldecode($_POST['mobile'])));
	$email = trim(stripslashes(rawurldecode($_POST['email'])));
	$website = trim(stripslashes(rawurldecode($_POST['website'])));
	$is_update = trim($_POST['isUpdate']);
	$signup_time = time();
	$last_modified_time = time();
	$currency_id = trim($_POST['currencyID']);
	$country_id = trim($_POST['countryID']);
	$time_zone = trim($_POST['timeZone']);
	$church_id = trim($_SESSION["churchID"]);
	
	$church_obj = new Church($APPLICATION_PATH);

	$status = array();

	/**/
	if(!$is_update)
	{
		//Thileepan, Rewrite this part please, I am commenting it for now. NESAN
		//$status = $church_obj->addChurchInformation($church_name, $church_desc, $church_addr, $landline, $mobile, $email, $website, $currency_id, $country_id, 0, $time_zone);
	} else {
		$status = $church_obj->updateChurchInformation($church_id, $church_name, $church_desc, $church_addr, $landline, $mobile, $email, $website, $last_modified_time, $currency_id, $country_id, $time_zone);
	}
	/**/

	echo $status[0];//Send just the result code, no need to send message as of now
	exit;
}
else if($req == 3)
{
	$curr_church_id = $_SESSION["churchID"];
	//get church information
	$church_obj = new Church($APPLICATION_PATH);
	//$church_details = $church_obj->getChurchInformation();
	$church_details = $church_obj->getInformationOfAChurch($curr_church_id);
	//array($church_id, $church_name, $church_desc, $church_addr, $landline, $mobile, $email, $website, $signup_time, $last_update_time, $sharded_database, $currency_id, $unique_hash, $status, $country_id, $referrer_church_id, $time_zone);
	$to_return = '';
	if($church_details[0]==1)
	{
		$church_id = $church_details[1][0];
		$church_misc_details = $church_obj->getChurchMiscDetails($church_id);
		if($church_misc_details[0]==1)
		{
			//$church_misc_details = array($currency_code, $currency_number, $currency_desc, $country_iso_code, $country_name, $country_iso3_code, $country_calling_code, $time_zone);
			$currency_desc = $church_misc_details[1][2];
			$country_name = $church_misc_details[1][4];
		}
		$church_name = $church_details[1][1];
		$church_desc = $church_details[1][2];
		$church_addr = $church_details[1][3];
		$landline = $church_details[1][4];
		$mobile = $church_details[1][5];
		$email = $church_details[1][6];
		$website = $church_details[1][7];
		$signup_time = $church_details[1][8];
		$last_modified_time = $church_details[1][9];
		$sharded_db = $church_details[1][10];
		$currency_id = $church_details[1][11];
		$unique_hash = $church_details[1][12];
		$status = $church_details[1][13];
		$country_id = $church_details[1][14];
		$referrer_church_id = $church_details[1][15];
		$time_zone = $church_details[1][16];

		$to_return .= '<div class="row-fluid">';
			$to_return .= '<div class="span8">';
				$to_return .= '<div>';
					$to_return .= '<b>';
						$to_return .= $church_name;
					$to_return .= '</b>&nbsp;&nbsp;&nbsp;<a href="#" onclick="getChurchInformationForm(1)">(Edit)</a>';
					$to_return .= '<BR><span class="muted">'.$church_desc.'</span>';
				$to_return .= '</div><BR>';
				$to_return .= '<div>';
					$to_return .= '<pre>';
					$to_return .= '<abbr title="Address">Address :</abbr>&nbsp;'.$church_addr;
					$to_return .= '<BR><abbr title="Phone">Phone :</abbr>&nbsp;'.$landline;
					$to_return .= '<BR><abbr title="Mobile">Mobile :</abbr>&nbsp;'.$mobile;
					$to_return .= '<BR><abbr title="Mobile">Email :</abbr>&nbsp;'.$email;
					$to_return .= '<BR><abbr title="Website">Website :</abbr>&nbsp;'.$website;
					$to_return .= '<BR><abbr title="Country">Country :</abbr>&nbsp;'.$country_name;
					$to_return .= '<BR><abbr title="TimeZone">Local Time Zone :</abbr>&nbsp;'.$time_zone;
					$to_return .= '<BR><abbr title="Currency">Local Currency :</abbr>&nbsp;'.$currency_desc;
				$to_return .= '</pre>';
				$to_return .= '</div><BR>';
			$to_return .= '</div>';
		$to_return .= '</div>';
	}
	else
	{
		$to_return .= '<div class="row-fluid">';
			$to_return .= '<div class="span12">';
				$to_return .= '<div class="alert alert-info"><b>Heads up!</b> You haven\'t added any information about your church yet. <a href="#" onclick="getChurchInformationForm(0);"><u>Click Here</u></a> to add.</div>';
			$to_return .= '</div>';
		$to_return .= '</div>';
	}

	echo $to_return;
	exit;
}
else if($req == 4)
{
	//get billing details

	$to_return .= '<div class="row-fluid">';
		$to_return .= '<div class="span10">';
			$to_return .= '<div class="widget">';
				$to_return .= '<div class="widget-header" style="background-color: lightgrey;color:black;">';
					$to_return .= '<i class="icon-asterisk icon-white"></i>';
		//			$to_return .= '<h3>Subscriptions ['.$dt->year.'] - In Indian Rupees</h3>';
					$to_return .= '<h3>Contributions</h3>';
					$to_return .= '<span class="pull-right" style="padding-right:10px;"><i class="icon-refresh icon-white curHand" onclick="getDashboardData(2);"></i></span>';
				$to_return .= '</div>';
				$to_return .= '<div class="widget-content">';
					$to_return .= '<div class="stats">';
						$to_return .= '<div class="stat">';
							$to_return .= '<span class="stat-value">'.$current_month_amount.'</span>';
							$to_return .= '<span class="muted">'.$current_month_in_string .','.$current_year_in_string.'</span>';
						$to_return .= '</div>';
						$to_return .= '<div class="stat">';
							$to_return .= '<span class="stat-value">'.$last_month_amount.'</span>';
							$to_return .= '<span class="muted">'.$last_month_in_string . ','.$last_year_in_string.'</span>';
						$to_return .= '</div>';
						$to_return .= '<div class="stat">';
							$to_return .= '<span class="stat-value">'.$prev_month_amount.'</span>';
							$to_return .= '<span class="muted">'.$prev_month_in_string . ','.$prev_year_in_string.'</span>';
						$to_return .= '</div>';
					$to_return .= '</div>';
				$to_return .= '</div>';
			$to_return .= '</div>';
		$to_return .= '</div>';
	$to_return .= '</div>';

	echo $to_return;
	exit;
}
else if($req==5)
{
	$to_return = '';
	$to_return .= '<div class="tabbable">';
		$to_return .= '<ul class="nav nav-tabs">';
			$to_return .= '<li id="changePasswordTab" class="active" onclick="showHideLoginCredTabs(1);"><a href="#changePasswordTab" data-toggle="tab">Change Password</a></li>';
			$to_return .= '<li id="changeEmailTab"  onclick="showHideLoginCredTabs(2);"><a href="#changeEmailTab" data-toggle="tab">Change Email</a></li>';
		$to_return .= '</ul>';
		$to_return .= '<div class="tab-content">';
			$to_return .= '<div class="tab-pane active" id="changePasswordDiv">';
			$to_return .= '</div>';
			$to_return .= '<div class="tab-pane" id="changeEmailDiv">';
			$to_return .= '</div>';
		$to_return .= '</div>';
	$to_return .= '</div>';

	echo $to_return;
	exit;
}
else if($req==6)
{
	$tabType = trim($_POST["tabType"]);
	if($tabType==1)
	{
		$divHTML = '';
		$divHTML .= '<div style="padding-bottom:6px;"><label class="control-label" for="txtNewPassword">New Password</label><div class="controls"><input type="password" id="txtNewPassword" placeholder="New Password" value=""></div></div>';
		$divHTML .= '<div style="padding-bottom:6px;"><label class="control-label" for="txtConfirmPassword">Confirm Password</label><div class="controls"><input type="password" id="txtConfirmPassword" placeholder="Repeat New Password" value=""></div></div>';
		$divHTML .= '<div style="padding-bottom:6px;"><button class="btn btn-primary" type="submit" onclick="updateLoginCredentials(1);">Update</button></div>';
	}
	else if($tabType==2)
	{
		$divHTML = '';
		$divHTML .= '<div style="padding-bottom:6px;" class="text-warning">This is the email address with which you will login to your church account. All notifications and invoices will also be sent to this email address only. Make sure you have access to the new email address you are going to specify now.</div>';
		$divHTML .= '<div style="padding-bottom:6px;"><label class="control-label" for="txtCurrentEmail">Existing Email Address</label><div class="controls"><input type="text" id="txtCurrentEmail" placeholder="" value="'.$_SESSION['email'].'" readonly></div></div>';
		$divHTML .= '<div style="padding-bottom:6px;"><label class="control-label" for="txtNewEmail">New Email Address</label><div class="controls"><input type="email" id="txtNewEmail" placeholder="New Email" value=""></div></div>';
		$divHTML .= '<div style="padding-bottom:6px;"><button class="btn btn-primary" type="submit" onclick="updateLoginCredentials(2);">Update</button></div>';
	}

	$ret_array = array("tabType"=>$tabType, "divHTML"=>$divHTML);
	$json = new Services_JSON();
	$encode_obj = $json->encode($ret_array);
	unset($json);

	echo $encode_obj;
	exit;
}
else if($req==7)
{
	$tabType = trim($_POST["tabType"]);

	$rsno = 0;
	$msg = "Unable to update the data";
	if($tabType==1)
	{
		$new_password = trim(stripslashes(rawurldecode($_POST['newPassword'])));
		$new_password = md5($new_password);
		$users_obj = new Users($APPLICATION_PATH);
		$pwd_result = $users_obj->changeUserPassword($_SESSION["email"], $new_password);
		$rsno = $pwd_result[0];
		$msg = $pwd_result[1];
	}
	else if($tabType==2)
	{
		$new_email = trim(stripslashes(rawurldecode($_POST['newEmail'])));
		$users_obj = new Users($APPLICATION_PATH);
		$email_result = $users_obj->changeUserEmailAddress($_SESSION["userID"], $new_email);
		$rsno = $email_result[0];
		$msg = $email_result[1];
	}

	$ret_array = array("tabType"=>$tabType, "rsno"=>$rsno, "msg"=>$msg);
	$json = new Services_JSON();
	$encode_obj = $json->encode($ret_array);
	unset($json);

	echo $encode_obj;
	exit;
}
?>